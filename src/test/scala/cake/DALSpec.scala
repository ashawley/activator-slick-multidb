import org.specs2.mutable.Specification
import org.specs2.concurrent.ExecutionEnv
// import org.specs2.specification.ExecutionEnvironment
import org.specs2.mutable.After
// import org.specs2.mock.Mockito
import org.scalamock.specs2.IsolatedMockFactory
import org.specs2.matcher.ThrownExpectations

import slick.driver.{H2Driver, SQLiteDriver}
import slick.jdbc.JdbcBackend.Database
// import slick.jdbc.JdbcBackend.JdbcActionContext
import slick.util.AsyncExecutor
import slick.dbio.DBIO

class DALSpec extends Specification with IsolatedMockFactory with ThrownExpectations with After {

  val connection = stub[java.sql.Connection]
  val dataSource = stub[slick.jdbc.JdbcDataSource]
  val preparedStatement = stub[java.sql.PreparedStatement]

  // 
  // val actionContext = mock[JdbcActionContext]
  val executor = AsyncExecutor.default("DALSpec") // mock[AsyncExecutor]

  val db = new Database(dataSource, executor)

  val h2 = new DAL(H2Driver)
  val sqlite = new DAL(SQLiteDriver)

  "H2 driver" should {
    "have a config" in {
      Database.forConfig("h2") must beAnInstanceOf[Database]
    }
    "have a DAL" in {
      h2 must beAnInstanceOf[DAL]
    }
  }
  "SQLite driver" should {
    "have a config" in {
      Database.forConfig("sqlite") must beAnInstanceOf[Database]
    }
    "have a DAL" in {
      sqlite must beAnInstanceOf[DAL]
    }
  }
  "Mock database" should {
    "create" in { implicit context: ExecutionEnv =>
      db must beAnInstanceOf[Database]
      (dataSource.createConnection _).when().returns(connection)
      (connection.prepareStatement (_: String)).when("create table \"USERS\" (\"USER_NAME\" VARCHAR NOT NULL,\"PIC_ID\" INTEGER NOT NULL,\"USER_ID\" INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) PRIMARY KEY)").returns(preparedStatement).once
      (connection.prepareStatement (_: String)).when("create table \"PICTURES\" (\"PIC_URL\" VARCHAR NOT NULL,\"PIC_ID\" INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1) PRIMARY KEY)").returns(preparedStatement).once
      db.run {
        h2.create
      } must beEqualTo((): Unit).await
      success
    }
  }

  def after = {
    Util.unloadDrivers
  }
}
